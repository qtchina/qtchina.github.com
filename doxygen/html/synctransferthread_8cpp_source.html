<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>nullfxp: synctransferthread.cpp源文件</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- 制作者 Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>首页</span></a></li>
      <li><a href="annotated.html"><span>类</span></a></li>
      <li class="current"><a href="files.html"><span>文件</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>文件列表</span></a></li>
      <li><a href="globals.html"><span>文件成员</span></a></li>
    </ul>
  </div>
<h1>synctransferthread.cpp</h1><a href="synctransferthread_8cpp.html">浏览该文件的文档。</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">// synctransferthread.cpp --- </span>
<a name="l00002"></a>00002 <span class="comment">// </span>
<a name="l00003"></a>00003 <span class="comment">// Author: liuguangzhao</span>
<a name="l00004"></a>00004 <span class="comment">// Copyright (C) 2007-2010 liuguangzhao@users.sf.net</span>
<a name="l00005"></a>00005 <span class="comment">// URL: http://www.qtchina.net http://nullget.sourceforge.net</span>
<a name="l00006"></a>00006 <span class="comment">// Created: 2009-01-11 10:19:22 +0800</span>
<a name="l00007"></a>00007 <span class="comment">// Version: $Id: synctransferthread.cpp 532 2009-10-07 03:39:29Z liuguangzhao $</span>
<a name="l00008"></a>00008 <span class="comment">// </span>
<a name="l00009"></a>00009 
<a name="l00010"></a>00010 <span class="preprocessor">#ifndef _MSC_VER</span>
<a name="l00011"></a><a class="code" href="synctransferthread_8cpp.html#a2aae46056558e9d6fef6380f9678ffe3">00011</a> <span class="preprocessor"></span><span class="preprocessor">#define HAVE_SYS_TIME_H</span>
<a name="l00012"></a>00012 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00013"></a>00013 <span class="preprocessor"></span>
<a name="l00014"></a>00014 <span class="preprocessor">#ifdef HAVE_SYS_TIME_H</span>
<a name="l00015"></a>00015 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/time.h&gt;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#endif</span>
<a name="l00017"></a>00017 <span class="preprocessor"></span>
<a name="l00018"></a>00018 <span class="preprocessor">#ifdef _MSC_VER</span>
<a name="l00019"></a>00019 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/utime.h&gt;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#endif</span>
<a name="l00021"></a>00021 <span class="preprocessor"></span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &quot;<a class="code" href="utils_8h.html">utils.h</a>&quot;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;<a class="code" href="globaloption_8h.html">globaloption.h</a>&quot;</span>
<a name="l00024"></a>00024 <span class="comment">// #include &quot;remotehostconnectthread.h&quot;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;<a class="code" href="sshconnection_8h.html">sshconnection.h</a>&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="basestorage_8h.html">basestorage.h</a>&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="sshfileinfo_8h.html">sshfileinfo.h</a>&quot;</span>
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="synctransferthread_8h.html">synctransferthread.h</a>&quot;</span>
<a name="l00030"></a>00030 
<a name="l00031"></a><a class="code" href="class_sync_transfer_thread.html#a0c0517944fdaf56d7129541c79ff83f0">00031</a> <a class="code" href="class_sync_transfer_thread.html#a0c0517944fdaf56d7129541c79ff83f0">SyncTransferThread::SyncTransferThread</a>(QObject *<a class="code" href="class_sync_differ_model.html#ae356eca4942998896c21ad296af65783">parent</a>)
<a name="l00032"></a>00032     : QThread(parent)
<a name="l00033"></a>00033 {
<a name="l00034"></a>00034     <a class="code" href="class_sync_transfer_thread.html#ab4c02dde0dda8f4fb95a99c9d9782453">ssh2_sess</a> = NULL;
<a name="l00035"></a>00035     <a class="code" href="class_sync_transfer_thread.html#a8be0003156ab3c73520c300ea14e51f1">ssh2_sftp</a> = NULL;
<a name="l00036"></a>00036     <a class="code" href="class_sync_transfer_thread.html#a0994ba3772ef608a805a5647160b45eb">hsftp</a> = NULL;    
<a name="l00037"></a>00037 }
<a name="l00038"></a><a class="code" href="class_sync_transfer_thread.html#a28f56bac008a127b9c8f24b909431a0b">00038</a> <a class="code" href="class_sync_transfer_thread.html#a28f56bac008a127b9c8f24b909431a0b">SyncTransferThread::~SyncTransferThread</a>()
<a name="l00039"></a>00039 {
<a name="l00040"></a>00040 }
<a name="l00041"></a>00041 
<a name="l00042"></a><a class="code" href="class_sync_transfer_thread.html#accafe04c12ff0aaba7b10a18f4e25e6f">00042</a> <span class="keywordtype">void</span> <a class="code" href="class_sync_transfer_thread.html#accafe04c12ff0aaba7b10a18f4e25e6f">SyncTransferThread::run</a>()
<a name="l00043"></a>00043 {
<a name="l00044"></a>00044     <a class="code" href="class_sync_task_package.html">SyncTaskPackage</a> task;
<a name="l00045"></a>00045     <span class="keywordtype">int</span> rc ;
<a name="l00046"></a>00046     <span class="keywordflow">while</span> (<span class="keyword">true</span>) {
<a name="l00047"></a>00047         this-&gt;<a class="code" href="class_sync_transfer_thread.html#ad18299ce4b0e1d51276c5d76024d8ae4">wcMutex</a>.lock();
<a name="l00048"></a>00048         <a class="code" href="utils_8h.html#a387853dd138b03f9523b75ee4c7e4a78">q_debug</a>()&lt;&lt;<span class="stringliteral">&quot;before waiting...&quot;</span>;
<a name="l00049"></a>00049         this-&gt;<a class="code" href="class_sync_transfer_thread.html#abdbba287c0749c6ae8efa8d5d1516509">wc</a>.wait(&amp;this-&gt;<a class="code" href="class_sync_transfer_thread.html#ad18299ce4b0e1d51276c5d76024d8ae4">wcMutex</a>);
<a name="l00050"></a>00050         <a class="code" href="utils_8h.html#a387853dd138b03f9523b75ee4c7e4a78">q_debug</a>()&lt;&lt;<span class="stringliteral">&quot;after waiting...&quot;</span>;
<a name="l00051"></a>00051         
<a name="l00052"></a>00052         <span class="keywordflow">while</span> (!this-&gt;<a class="code" href="class_sync_transfer_thread.html#ab6afbfd258dc28d46ab7aea47a3e143d">taskQueue</a>.empty()) {
<a name="l00053"></a>00053             this-&gt;<a class="code" href="class_sync_transfer_thread.html#a2aebe583aa8473fad635919bbfaf1383">tMutex</a>.lock();
<a name="l00054"></a>00054             task = this-&gt;<a class="code" href="class_sync_transfer_thread.html#ab6afbfd258dc28d46ab7aea47a3e143d">taskQueue</a>.dequeue();
<a name="l00055"></a>00055             this-&gt;<a class="code" href="class_sync_transfer_thread.html#a2aebe583aa8473fad635919bbfaf1383">tMutex</a>.unlock();
<a name="l00056"></a>00056             
<a name="l00057"></a>00057             rc = this-&gt;<a class="code" href="class_sync_transfer_thread.html#a5a10ef8c7d5f25c9c88f412851d7b5a5">transfer_impl</a>(task); 
<a name="l00058"></a>00058             <span class="keywordflow">if</span> (rc == <a class="code" href="class_sync_transfer_thread.html#a94233e4ed33f30697c2502a127d4390ca2d73ac892f5e4485e8919f057f2092ba">TASK_ERROR_CONN_FAILD</a>) {
<a name="l00059"></a>00059                 <a class="code" href="utils_8h.html#a387853dd138b03f9523b75ee4c7e4a78">q_debug</a>()&lt;&lt;<span class="stringliteral">&quot;conn error&quot;</span>;
<a name="l00060"></a>00060                 this-&gt;<a class="code" href="class_sync_transfer_thread.html#ad18299ce4b0e1d51276c5d76024d8ae4">wcMutex</a>.unlock();
<a name="l00061"></a>00061                 <span class="keywordflow">goto</span> out_thread;
<a name="l00062"></a>00062             }
<a name="l00063"></a>00063             <span class="keywordflow">if</span> (rc == <a class="code" href="class_sync_transfer_thread.html#a94233e4ed33f30697c2502a127d4390caad16cf9dfecfc45d37120265c34a0bee">TASK_ERROR_OTHER</a>) {
<a name="l00064"></a>00064                 <a class="code" href="utils_8h.html#a387853dd138b03f9523b75ee4c7e4a78">q_debug</a>()&lt;&lt;<span class="stringliteral">&quot;other error&quot;</span>;
<a name="l00065"></a>00065             }
<a name="l00066"></a>00066             <span class="keywordflow">if</span> (rc == <a class="code" href="class_sync_transfer_thread.html#a94233e4ed33f30697c2502a127d4390caf38b660b45d93c87d52f9c81c459e15e">TASK_OK</a>) {
<a name="l00067"></a>00067             }
<a name="l00068"></a>00068         }
<a name="l00069"></a>00069         this-&gt;<a class="code" href="class_sync_transfer_thread.html#ad18299ce4b0e1d51276c5d76024d8ae4">wcMutex</a>.unlock();
<a name="l00070"></a>00070     }
<a name="l00071"></a>00071  out_thread:
<a name="l00072"></a>00072     return ;
<a name="l00073"></a>00073 }
<a name="l00074"></a>00074 
<a name="l00075"></a><a class="code" href="class_sync_transfer_thread.html#a5a10ef8c7d5f25c9c88f412851d7b5a5">00075</a> <span class="keywordtype">int</span> <a class="code" href="class_sync_transfer_thread.html#a5a10ef8c7d5f25c9c88f412851d7b5a5">SyncTransferThread::transfer_impl</a>(<a class="code" href="class_sync_task_package.html">SyncTaskPackage</a> task)
<a name="l00076"></a>00076 {
<a name="l00077"></a>00077     <span class="keywordflow">if</span> (!this-&gt;<a class="code" href="class_sync_transfer_thread.html#ab4c02dde0dda8f4fb95a99c9d9782453">ssh2_sess</a>) {
<a name="l00078"></a>00078         <span class="keywordflow">if</span> (!this-&gt;<a class="code" href="class_sync_transfer_thread.html#aba5cd9bd2b376175adc25335f900b6fb">connectToRemoteHost</a>()) {
<a name="l00079"></a>00079             <span class="keywordflow">return</span> <a class="code" href="class_sync_transfer_thread.html#a94233e4ed33f30697c2502a127d4390ca2d73ac892f5e4485e8919f057f2092ba">TASK_ERROR_CONN_FAILD</a>;
<a name="l00080"></a>00080         }
<a name="l00081"></a>00081     }
<a name="l00082"></a>00082     Q_ASSERT(this-&gt;<a class="code" href="class_sync_transfer_thread.html#ab4c02dde0dda8f4fb95a99c9d9782453">ssh2_sess</a> != NULL);
<a name="l00083"></a>00083     Q_ASSERT(this-&gt;<a class="code" href="class_sync_transfer_thread.html#a8be0003156ab3c73520c300ea14e51f1">ssh2_sftp</a> != NULL);
<a name="l00084"></a>00084 
<a name="l00085"></a>00085     <span class="keywordflow">if</span> (task.<a class="code" href="class_sync_task_package.html#aa59963442208b78f07b5a22b1f19a5b4">mnDirect</a> == <a class="code" href="class_sync_transfer_thread.html#abd241410e5359aa406455b981579542ea1ef4a1cac27b6de9502d5e4ccedd1430">TASK_DOWNLOAD</a>) {
<a name="l00086"></a>00086         <span class="keywordflow">return</span> this-&gt;<a class="code" href="class_sync_transfer_thread.html#acf9faaec1c53495009fb15a6b2d2e70d">do_download</a>(this-&gt;<a class="code" href="class_sync_transfer_thread.html#ae6d48e34639c085cbaf94f8d16e0a783">remote_base_path</a> + <span class="stringliteral">&quot;/&quot;</span> + task.<a class="code" href="class_sync_task_package.html#ae2dc5afdc3ffab8599fde6a324d76ad6">msFileName</a>,
<a name="l00087"></a>00087                                  this-&gt;local_base_path + <span class="stringliteral">&quot;/&quot;</span> + task.<a class="code" href="class_sync_task_package.html#ae2dc5afdc3ffab8599fde6a324d76ad6">msFileName</a>);
<a name="l00088"></a>00088     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (task.<a class="code" href="class_sync_task_package.html#aa59963442208b78f07b5a22b1f19a5b4">mnDirect</a> == <a class="code" href="class_sync_transfer_thread.html#abd241410e5359aa406455b981579542ea5765bf12d36b45c3e59ae18bc0793a26">TASK_UPLOAD</a>) {
<a name="l00089"></a>00089         <span class="keywordflow">return</span> this-&gt;<a class="code" href="class_sync_transfer_thread.html#a00905da2acd84012f70884d20add24b8">do_upload</a>(this-&gt;<a class="code" href="class_sync_transfer_thread.html#ad9c61029cc82f0e9f39561e3adb6aba6">local_base_path</a> + <span class="stringliteral">&quot;/&quot;</span> + task.<a class="code" href="class_sync_task_package.html#ae2dc5afdc3ffab8599fde6a324d76ad6">msFileName</a>,
<a name="l00090"></a>00090                                this-&gt;remote_base_path + <span class="stringliteral">&quot;/&quot;</span> + task.<a class="code" href="class_sync_task_package.html#ae2dc5afdc3ffab8599fde6a324d76ad6">msFileName</a>);
<a name="l00091"></a>00091     } <span class="keywordflow">else</span> {
<a name="l00092"></a>00092         Q_ASSERT(1 == 2);
<a name="l00093"></a>00093     }
<a name="l00094"></a>00094     
<a name="l00095"></a>00095     <span class="keywordflow">return</span> <a class="code" href="class_sync_transfer_thread.html#a94233e4ed33f30697c2502a127d4390caf38b660b45d93c87d52f9c81c459e15e">TASK_OK</a>;
<a name="l00096"></a>00096 }
<a name="l00097"></a>00097 
<a name="l00098"></a><a class="code" href="class_sync_transfer_thread.html#acf9faaec1c53495009fb15a6b2d2e70d">00098</a> <span class="keywordtype">int</span> <a class="code" href="class_sync_transfer_thread.html#acf9faaec1c53495009fb15a6b2d2e70d">SyncTransferThread::do_download</a>(QString remote_path, QString local_path)
<a name="l00099"></a>00099 {
<a name="l00100"></a>00100     qDebug() &lt;&lt;__FUNCTION__&lt;&lt;<span class="stringliteral">&quot;: &quot;</span>&lt;&lt;__LINE__&lt;&lt;<span class="stringliteral">&quot;:&quot;</span>&lt;&lt; __FILE__; 
<a name="l00101"></a>00101     qDebug()&lt;&lt; <span class="stringliteral">&quot;remote_path = &quot;</span>&lt;&lt;  remote_path  &lt;&lt; <span class="stringliteral">&quot; , local_path = &quot;</span> &lt;&lt; local_path ;
<a name="l00102"></a>00102     <span class="keywordtype">int</span> pcnt = 0 ;
<a name="l00103"></a>00103     <span class="keywordtype">int</span>  rlen , wlen  ;
<a name="l00104"></a>00104     <span class="keywordtype">int</span> file_size , tran_len = 0   ;
<a name="l00105"></a>00105     LIBSSH2_SFTP_HANDLE * sftp_handle ;
<a name="l00106"></a>00106     LIBSSH2_SFTP_ATTRIBUTES ssh2_sftp_attrib;
<a name="l00107"></a>00107     <span class="keywordtype">char</span> buff[8192] = {0};
<a name="l00108"></a>00108     QString currFile;
<a name="l00109"></a>00109     
<a name="l00110"></a>00110     sftp_handle = libssh2_sftp_open(this-&gt;<a class="code" href="class_sync_transfer_thread.html#a8be0003156ab3c73520c300ea14e51f1">ssh2_sftp</a>,
<a name="l00111"></a>00111                                     <a class="code" href="class_global_option.html#a23a5b10888b23504a10b5c7b96bddc62">GlobalOption::instance</a>()-&gt;remote_codec-&gt;fromUnicode(remote_path), LIBSSH2_FXF_READ, 0);
<a name="l00112"></a>00112     <span class="keywordflow">if</span> (sftp_handle == NULL) {
<a name="l00113"></a>00113         <span class="comment">//TODO 错误消息通知用户。</span>
<a name="l00114"></a>00114         qDebug()&lt;&lt;<span class="stringliteral">&quot;open sftp file error :&quot;</span>&lt;&lt; libssh2_sftp_last_error(this-&gt;<a class="code" href="class_sync_transfer_thread.html#a8be0003156ab3c73520c300ea14e51f1">ssh2_sftp</a>);
<a name="l00115"></a>00115         <span class="keywordflow">return</span> -1 ;
<a name="l00116"></a>00116     }
<a name="l00117"></a>00117     
<a name="l00118"></a>00118     memset(&amp;ssh2_sftp_attrib,0,<span class="keyword">sizeof</span>(ssh2_sftp_attrib));
<a name="l00119"></a>00119     libssh2_sftp_fstat(sftp_handle,&amp;ssh2_sftp_attrib);
<a name="l00120"></a>00120     file_size = ssh2_sftp_attrib.filesize;
<a name="l00121"></a>00121     qDebug()&lt;&lt;<span class="stringliteral">&quot; remote file size :&quot;</span>&lt;&lt; file_size ;
<a name="l00122"></a>00122 
<a name="l00123"></a>00123     currFile = local_path.right(local_path.length() - this-&gt;<a class="code" href="class_sync_transfer_thread.html#ad9c61029cc82f0e9f39561e3adb6aba6">local_base_path</a>.length() - 1);
<a name="l00124"></a>00124     emit this-&gt;<a class="code" href="class_sync_transfer_thread.html#a0d270b21df68d8c6164f3eaae5d17de9">syncFileStarted</a>(currFile, file_size);
<a name="l00125"></a>00125 
<a name="l00126"></a>00126     <span class="comment">// 本地编码 --&gt; Qt 内部编码</span>
<a name="l00127"></a>00127     QFile q_file(local_path);
<a name="l00128"></a>00128     <span class="keywordflow">if</span> (!q_file.open(QIODevice::ReadWrite|QIODevice::Truncate)) {
<a name="l00129"></a>00129         <span class="comment">//TODO 错误消息通知用户。</span>
<a name="l00130"></a>00130         qDebug()&lt;&lt;<span class="stringliteral">&quot;open local file error:&quot;</span>&lt;&lt; q_file.errorString() ;        
<a name="l00131"></a>00131     } <span class="keywordflow">else</span> {
<a name="l00132"></a>00132         <span class="comment">//read remote file  and then write to local file</span>
<a name="l00133"></a>00133         <span class="keywordflow">while</span> ((rlen = libssh2_sftp_read(sftp_handle, buff, <span class="keyword">sizeof</span>(buff))) &gt; 0) {
<a name="l00134"></a>00134             wlen = q_file.write( buff, rlen );
<a name="l00135"></a>00135             tran_len += wlen ;
<a name="l00136"></a>00136             qDebug()&lt;&lt;<span class="stringliteral">&quot;Read len :&quot;</span>&lt;&lt;rlen &lt;&lt;<span class="stringliteral">&quot; , write len: &quot;</span>&lt;&lt;wlen
<a name="l00137"></a>00137                      &lt;&lt;<span class="stringliteral">&quot; tran len: &quot;</span>&lt;&lt;tran_len ;
<a name="l00138"></a>00138             <span class="comment">//my progress signal</span>
<a name="l00139"></a>00139             <span class="keywordflow">if</span> (file_size == 0) {
<a name="l00140"></a>00140                 emit this-&gt;<a class="code" href="class_sync_transfer_thread.html#ae1a6f14c1ed027be9ced51d71975a54c">transfer_percent_changed</a>(currFile, 100, tran_len, wlen);
<a name="l00141"></a>00141             } <span class="keywordflow">else</span> {
<a name="l00142"></a>00142                 pcnt = 100.0 *((double)tran_len  / (<span class="keywordtype">double</span>)file_size);
<a name="l00143"></a>00143                 emit this-&gt;<a class="code" href="class_sync_transfer_thread.html#ae1a6f14c1ed027be9ced51d71975a54c">transfer_percent_changed</a>(currFile, pcnt, tran_len, wlen);
<a name="l00144"></a>00144             }
<a name="l00145"></a>00145         }
<a name="l00146"></a>00146         q_file.flush();
<a name="l00147"></a>00147         q_file.close();
<a name="l00148"></a>00148     }
<a name="l00149"></a>00149     libssh2_sftp_close(sftp_handle);
<a name="l00150"></a>00150     <a class="code" href="utils_8h.html#a387853dd138b03f9523b75ee4c7e4a78">q_debug</a>()&lt;&lt;<span class="stringliteral">&quot;syncDownload done.&quot;</span>;
<a name="l00151"></a>00151     this-&gt;<a class="code" href="class_sync_transfer_thread.html#abb8992376ee231e008ef6862a896f1ca">do_touch_local_file_with_time</a>(local_path, <a class="code" href="class_s_s_h_file_info.html">SSHFileInfo</a>(ssh2_sftp_attrib).lastModified());
<a name="l00152"></a>00152 
<a name="l00153"></a>00153     emit this-&gt;<a class="code" href="class_sync_transfer_thread.html#ac40b4297ba1763b5eb3e8020ef20f96d">syncFileStopped</a>(currFile, 0);
<a name="l00154"></a>00154 
<a name="l00155"></a>00155     <span class="keywordflow">return</span> 0;
<a name="l00156"></a>00156 }
<a name="l00157"></a>00157 
<a name="l00158"></a><a class="code" href="class_sync_transfer_thread.html#a00905da2acd84012f70884d20add24b8">00158</a> <span class="keywordtype">int</span> <a class="code" href="class_sync_transfer_thread.html#a00905da2acd84012f70884d20add24b8">SyncTransferThread::do_upload</a>(QString local_path, QString remote_path)
<a name="l00159"></a>00159 {
<a name="l00160"></a>00160     qDebug() &lt;&lt;__FUNCTION__&lt;&lt;<span class="stringliteral">&quot;: &quot;</span>&lt;&lt;__LINE__&lt;&lt;<span class="stringliteral">&quot;:&quot;</span>&lt;&lt; __FILE__; 
<a name="l00161"></a>00161     qDebug()&lt;&lt; <span class="stringliteral">&quot;remote_path = &quot;</span>&lt;&lt;  remote_path  &lt;&lt; <span class="stringliteral">&quot; , local_path = &quot;</span> &lt;&lt; local_path ;
<a name="l00162"></a>00162 
<a name="l00163"></a>00163     <span class="keywordtype">int</span> pcnt = 0 ;
<a name="l00164"></a>00164     <span class="keywordtype">int</span> rlen , wlen  ;
<a name="l00165"></a>00165     <span class="keywordtype">int</span> file_size , tran_len = 0   ;
<a name="l00166"></a>00166     LIBSSH2_SFTP_HANDLE * sftp_handle ;
<a name="l00167"></a>00167     LIBSSH2_SFTP_ATTRIBUTES ssh2_sftp_attrib;
<a name="l00168"></a>00168     <span class="keywordtype">char</span> buff[5120] = {0};
<a name="l00169"></a>00169     QString currFile;
<a name="l00170"></a>00170     
<a name="l00171"></a>00171     <span class="comment">//TODO 检查文件可写属性</span>
<a name="l00172"></a>00172     sftp_handle = libssh2_sftp_open(this-&gt;<a class="code" href="class_sync_transfer_thread.html#a8be0003156ab3c73520c300ea14e51f1">ssh2_sftp</a>,
<a name="l00173"></a>00173                                     <a class="code" href="class_global_option.html#a23a5b10888b23504a10b5c7b96bddc62">GlobalOption::instance</a>()-&gt;remote_codec-&gt;fromUnicode(remote_path),
<a name="l00174"></a>00174                                     LIBSSH2_FXF_READ|LIBSSH2_FXF_WRITE|LIBSSH2_FXF_CREAT|LIBSSH2_FXF_TRUNC, 0666);
<a name="l00175"></a>00175     <span class="keywordflow">if</span> (sftp_handle == NULL) {
<a name="l00176"></a>00176         <span class="comment">//TODO 错误消息通知用户。</span>
<a name="l00177"></a>00177         <span class="keywordtype">char</span> errmsg[200] = {0};
<a name="l00178"></a>00178         <span class="keywordtype">int</span> emlen = 0;
<a name="l00179"></a>00179         libssh2_session_last_error(this-&gt;<a class="code" href="class_sync_transfer_thread.html#ab4c02dde0dda8f4fb95a99c9d9782453">ssh2_sess</a>, (<span class="keywordtype">char</span> **)&amp;errmsg, &amp;emlen, 0);
<a name="l00180"></a>00180         
<a name="l00181"></a>00181         qDebug()&lt;&lt;<span class="stringliteral">&quot;open sftp file error :&quot;</span>&lt;&lt; libssh2_sftp_last_error(this-&gt;<a class="code" href="class_sync_transfer_thread.html#a8be0003156ab3c73520c300ea14e51f1">ssh2_sftp</a>)
<a name="l00182"></a>00182                 &lt;&lt;QString(errmsg);
<a name="l00183"></a>00183         <span class="keywordflow">if</span> (libssh2_sftp_last_error(this-&gt;<a class="code" href="class_sync_transfer_thread.html#a8be0003156ab3c73520c300ea14e51f1">ssh2_sftp</a>) == LIBSSH2_FX_PERMISSION_DENIED) {
<a name="l00184"></a>00184             <span class="comment">// this-&gt;errorString = QString(tr(&quot;Open file faild, Permission denied&quot;));</span>
<a name="l00185"></a>00185             <span class="comment">// qDebug()&lt;&lt;this-&gt;errorString;</span>
<a name="l00186"></a>00186         }
<a name="l00187"></a>00187         <span class="comment">// this-&gt;error_code = ERRNO_BASE + libssh2_sftp_last_error(this-&gt;ssh2_sftp);</span>
<a name="l00188"></a>00188         emit this-&gt;<a class="code" href="class_sync_transfer_thread.html#ac40b4297ba1763b5eb3e8020ef20f96d">syncFileStopped</a>(currFile, -1);
<a name="l00189"></a>00189         <span class="keywordflow">return</span> -1 ;
<a name="l00190"></a>00190     }
<a name="l00191"></a>00191     
<a name="l00192"></a>00192     memset(&amp;ssh2_sftp_attrib,0,<span class="keyword">sizeof</span>(ssh2_sftp_attrib));
<a name="l00193"></a>00193     QFileInfo local_fi(local_path);
<a name="l00194"></a>00194     file_size = local_fi.size();
<a name="l00195"></a>00195     qDebug()&lt;&lt;<span class="stringliteral">&quot;local file size:&quot;</span> &lt;&lt; file_size ;
<a name="l00196"></a>00196 
<a name="l00197"></a>00197     currFile = local_path.right(local_path.length() - this-&gt;<a class="code" href="class_sync_transfer_thread.html#ad9c61029cc82f0e9f39561e3adb6aba6">local_base_path</a>.length() - 1);
<a name="l00198"></a>00198     emit this-&gt;<a class="code" href="class_sync_transfer_thread.html#a0d270b21df68d8c6164f3eaae5d17de9">syncFileStarted</a>(currFile, file_size);
<a name="l00199"></a>00199     
<a name="l00200"></a>00200     <span class="comment">// 本地编码 --&gt; Qt 内部编码</span>
<a name="l00201"></a>00201     QFile q_file(local_path);
<a name="l00202"></a>00202     <span class="keywordflow">if</span> (!q_file.open( QIODevice::ReadOnly)) {
<a name="l00203"></a>00203         <span class="comment">//TODO 错误消息通知用户。</span>
<a name="l00204"></a>00204         qDebug()&lt;&lt;<span class="stringliteral">&quot;open local file error:&quot;</span>&lt;&lt; q_file.errorString()  ;
<a name="l00205"></a>00205         <span class="comment">//printf(&quot;open local file error:%s\n&quot;, strerror( errno ) );        </span>
<a name="l00206"></a>00206     } <span class="keywordflow">else</span> {
<a name="l00207"></a>00207         <span class="comment">//read local file and then write to remote file</span>
<a name="l00208"></a>00208         <span class="keywordflow">while</span> (!q_file.atEnd()) {
<a name="l00209"></a>00209             qDebug()&lt;&lt;<span class="stringliteral">&quot;Read local ... &quot;</span>;
<a name="l00210"></a>00210             rlen = q_file.read(buff, <span class="keyword">sizeof</span>(buff));
<a name="l00211"></a>00211             qDebug()&lt;&lt;<span class="stringliteral">&quot;Read local done &quot;</span>;
<a name="l00212"></a>00212             <span class="keywordflow">if</span> (rlen &lt;= 0) {
<a name="l00213"></a>00213                 <span class="comment">//qDebug()&lt;&lt;&quot;errno: &quot;&lt;&lt;errno&lt;&lt;&quot; err msg:&quot;&lt;&lt; strerror( errno) &lt;&lt; ftell( local_handle) ;</span>
<a name="l00214"></a>00214                 break ;
<a name="l00215"></a>00215             }
<a name="l00216"></a>00216             qDebug()&lt;&lt;<span class="stringliteral">&quot;write to sftp ... &quot;</span>;
<a name="l00217"></a>00217             wlen = libssh2_sftp_write(sftp_handle, buff, rlen);
<a name="l00218"></a>00218             qDebug()&lt;&lt;<span class="stringliteral">&quot;write to sftp done &quot;</span>;
<a name="l00219"></a>00219             Q_ASSERT(wlen == rlen);
<a name="l00220"></a>00220             tran_len += wlen ;
<a name="l00221"></a>00221             
<a name="l00222"></a>00222             <span class="comment">//qDebug()&lt;&lt;&quot; local read : &quot;&lt;&lt; rlen &lt;&lt; &quot; sftp write :&quot;&lt;&lt;wlen &lt;&lt;&quot; up len :&quot;&lt;&lt; tran_len ;</span>
<a name="l00223"></a>00223             <span class="comment">//          qDebug() &lt;&lt;&quot; read len :&quot;&lt;&lt; rlen &lt;&lt;&quot; , write len: &quot;&lt;&lt; wlen </span>
<a name="l00224"></a>00224             <span class="comment">//                    &lt;&lt; &quot; tran len: &quot;&lt;&lt; tran_len ;</span>
<a name="l00225"></a>00225             <span class="keywordflow">if</span> (file_size == 0 ) {
<a name="l00226"></a>00226                 emit this-&gt;<a class="code" href="class_sync_transfer_thread.html#ae1a6f14c1ed027be9ced51d71975a54c">transfer_percent_changed</a>(currFile, 100, tran_len, wlen);
<a name="l00227"></a>00227             } <span class="keywordflow">else</span> {
<a name="l00228"></a>00228                 pcnt = 100.0 *((double)tran_len  / (<span class="keywordtype">double</span>)file_size);
<a name="l00229"></a>00229                 <span class="comment">// qDebug()&lt;&lt; QString(&quot;100.0 *((double)%1  / (double)%2)&quot;).arg(tran_len).arg(file_size)&lt;&lt;&quot; = &quot;&lt;&lt;pcnt ;</span>
<a name="l00230"></a>00230                 emit this-&gt;<a class="code" href="class_sync_transfer_thread.html#ae1a6f14c1ed027be9ced51d71975a54c">transfer_percent_changed</a>(currFile, pcnt, tran_len, wlen);
<a name="l00231"></a>00231             }
<a name="l00232"></a>00232         }
<a name="l00233"></a>00233         q_file.close();
<a name="l00234"></a>00234     }
<a name="l00235"></a>00235     <span class="comment">// qDebug()&lt;&lt;&quot;out cycle, close sftp...&quot;;</span>
<a name="l00236"></a>00236     libssh2_sftp_close(sftp_handle);
<a name="l00237"></a>00237     <a class="code" href="utils_8h.html#a387853dd138b03f9523b75ee4c7e4a78">q_debug</a>()&lt;&lt;<span class="stringliteral">&quot;syncUpload done.&quot;</span>;
<a name="l00238"></a>00238     this-&gt;<a class="code" href="class_sync_transfer_thread.html#a00473fbfa639978e24e55530504084ec">do_touch_sftp_file_with_time</a>(remote_path, QFileInfo(local_path).lastModified());
<a name="l00239"></a>00239 
<a name="l00240"></a>00240     emit this-&gt;<a class="code" href="class_sync_transfer_thread.html#ac40b4297ba1763b5eb3e8020ef20f96d">syncFileStopped</a>(currFile, 0);
<a name="l00241"></a>00241 
<a name="l00242"></a>00242     <span class="keywordflow">return</span> 0;
<a name="l00243"></a>00243 }
<a name="l00244"></a>00244 
<a name="l00245"></a><a class="code" href="class_sync_transfer_thread.html#abb8992376ee231e008ef6862a896f1ca">00245</a> <span class="keywordtype">int</span> <a class="code" href="class_sync_transfer_thread.html#abb8992376ee231e008ef6862a896f1ca">SyncTransferThread::do_touch_local_file_with_time</a>(QString fileName, QDateTime time)
<a name="l00246"></a>00246 {
<a name="l00247"></a>00247     <span class="comment">// Linux 上可以使用 utime 或者 utimes 函数, - change file last access and modification times</span>
<a name="l00248"></a>00248     <span class="comment">// Windows 上文件 SetFileTime（）函数设置文件的创建时间、最近一次访问时间以及最近一次修改的时间等</span>
<a name="l00249"></a>00249     <span class="comment">// Windows 目录 两个函数GetDirTime()和SetDirTime()来实现对文件夹时间信息</span>
<a name="l00250"></a>00250     <span class="comment">// Qt 中好像是没有修改文件时间属性的方法。</span>
<a name="l00251"></a>00251 
<a name="l00252"></a>00252     <span class="keywordtype">int</span> ret;
<a name="l00253"></a>00253     QFileInfo fi(fileName);
<a name="l00254"></a>00254 
<a name="l00255"></a>00255 <span class="preprocessor">#ifdef WIN32</span>
<a name="l00256"></a>00256 <span class="preprocessor"></span>    <span class="comment">// method 1, ok</span>
<a name="l00257"></a>00257     QFile q_file(fileName);
<a name="l00258"></a>00258     <span class="keywordflow">if</span> (!q_file.open(QIODevice::ReadWrite)) {
<a name="l00259"></a>00259         <a class="code" href="utils_8h.html#a387853dd138b03f9523b75ee4c7e4a78">q_debug</a>()&lt;&lt;<span class="stringliteral">&quot;open file error:&quot;</span>&lt;&lt;q_file.errorString();
<a name="l00260"></a>00260     } <span class="keywordflow">else</span> {
<a name="l00261"></a>00261         <span class="keywordtype">int</span> fp = q_file.handle();
<a name="l00262"></a>00262         <span class="keyword">struct </span>_utimbuf ub;
<a name="l00263"></a>00263         ub.actime = fi.lastRead().toTime_t();
<a name="l00264"></a>00264         ub.modtime = time.toTime_t();
<a name="l00265"></a>00265         ret = _futime(fp, &amp;ub);
<a name="l00266"></a>00266         <a class="code" href="utils_8h.html#a387853dd138b03f9523b75ee4c7e4a78">q_debug</a>()&lt;&lt;<span class="stringliteral">&quot;_futime ret: &quot;</span>&lt;&lt;ret&lt;&lt;fileName
<a name="l00267"></a>00267                  &lt;&lt;strerror(ret);
<a name="l00268"></a>00268         q_file.close();
<a name="l00269"></a>00269     }
<a name="l00270"></a>00270     <span class="keywordflow">return</span> 0;
<a name="l00271"></a>00271 
<a name="l00272"></a>00272     <span class="comment">// method 2, english ok, chinese faild</span>
<a name="l00273"></a>00273     <span class="keyword">const</span> <span class="keywordtype">char</span> *filePathName = <a class="code" href="globaloption_8cpp.html#ae89292bef4edc9c349d22b5226f4558f">gOpt</a>-&gt;<a class="code" href="class_global_option.html#a9116eac51966d6215d471950f9aea1b4">locale_codec</a>-&gt;fromUnicode(QDir::toNativeSeparators(fileName)).constData();
<a name="l00274"></a>00274     <span class="keyword">struct </span>_utimbuf ub;
<a name="l00275"></a>00275     ub.actime = fi.lastRead().toTime_t();
<a name="l00276"></a>00276     ub.modtime = time.toTime_t();
<a name="l00277"></a>00277     ret = _utime(filePathName, &amp;ub);
<a name="l00278"></a>00278     <a class="code" href="utils_8h.html#a387853dd138b03f9523b75ee4c7e4a78">q_debug</a>()&lt;&lt;<span class="stringliteral">&quot;_utime ret: &quot;</span>&lt;&lt;ret&lt;&lt;filePathName&lt;&lt;fileName
<a name="l00279"></a>00279              &lt;&lt;strerror(ret);
<a name="l00280"></a>00280     <span class="keywordflow">return</span> 0;
<a name="l00281"></a>00281 
<a name="l00282"></a>00282     <span class="comment">// method 2, english ok, chinese faild</span>
<a name="l00283"></a>00283     QString appPath = QCoreApplication::applicationDirPath();
<a name="l00284"></a>00284     QString procFilePath = appPath + <span class="stringliteral">&quot;/touch.exe&quot;</span>;
<a name="l00285"></a>00285     QStringList args;
<a name="l00286"></a>00286     args&lt;&lt;<span class="stringliteral">&quot;-m&quot;</span>;
<a name="l00287"></a>00287     args&lt;&lt;<span class="stringliteral">&quot;-t&quot;</span>;
<a name="l00288"></a>00288     args&lt;&lt;time.toString(<span class="stringliteral">&quot;yyyyMMddhhmm.ss&quot;</span>);
<a name="l00289"></a>00289     args&lt;&lt;QDir::toNativeSeparators(fileName);
<a name="l00290"></a>00290     <a class="code" href="utils_8h.html#a387853dd138b03f9523b75ee4c7e4a78">q_debug</a>()&lt;&lt;args;
<a name="l00291"></a>00291     QProcess proc;
<a name="l00292"></a>00292     proc.start(procFilePath, args);
<a name="l00293"></a>00293     ret = proc.waitForFinished();
<a name="l00294"></a>00294 
<a name="l00295"></a>00295 <span class="preprocessor">#else</span>
<a name="l00296"></a>00296 <span class="preprocessor"></span>    <span class="keyword">struct </span>timeval tv[2] = {{0,0}, {0,0}};
<a name="l00297"></a>00297     tv[0].tv_sec = fi.lastRead().toTime_t();
<a name="l00298"></a>00298     tv[1].tv_sec = time.toTime_t();
<a name="l00299"></a>00299     ret = utimes(<a class="code" href="class_global_option.html#a23a5b10888b23504a10b5c7b96bddc62">GlobalOption::instance</a>()-&gt;locale_codec-&gt;fromUnicode(fileName), tv);
<a name="l00300"></a>00300     assert(ret == 0);    
<a name="l00301"></a>00301 <span class="preprocessor">#endif</span>
<a name="l00302"></a>00302 <span class="preprocessor"></span>
<a name="l00303"></a>00303     <span class="keywordflow">return</span> 0;
<a name="l00304"></a>00304 }
<a name="l00305"></a>00305 
<a name="l00306"></a><a class="code" href="class_sync_transfer_thread.html#a00473fbfa639978e24e55530504084ec">00306</a> <span class="keywordtype">int</span> <a class="code" href="class_sync_transfer_thread.html#a00473fbfa639978e24e55530504084ec">SyncTransferThread::do_touch_sftp_file_with_time</a>(QString fileName, QDateTime time)
<a name="l00307"></a>00307 {
<a name="l00308"></a>00308     <span class="comment">// sftp_open, 可以得到当前的文件属性</span>
<a name="l00309"></a>00309     <span class="comment">// sftp_close,</span>
<a name="l00310"></a>00310     <span class="comment">// 修改LIBSSH2_SFTP_ATTRIBUTE中的最后修改日期</span>
<a name="l00311"></a>00311     <span class="comment">// sftp_set_stat, 修改文件的最后修改日期。</span>
<a name="l00312"></a>00312 
<a name="l00313"></a>00313     LIBSSH2_SFTP_ATTRIBUTES attr;
<a name="l00314"></a>00314     <span class="keywordtype">int</span> ret;
<a name="l00315"></a>00315 
<a name="l00316"></a>00316     ret = libssh2_sftp_stat(this-&gt;<a class="code" href="class_sync_transfer_thread.html#a8be0003156ab3c73520c300ea14e51f1">ssh2_sftp</a>, <a class="code" href="class_global_option.html#a23a5b10888b23504a10b5c7b96bddc62">GlobalOption::instance</a>()-&gt;remote_codec-&gt;fromUnicode(fileName), &amp;attr);
<a name="l00317"></a>00317     <span class="keywordflow">if</span> (ret != 0) {
<a name="l00318"></a>00318         <span class="comment">//int libssh2_session_last_error(LIBSSH2_SESSION *session, char **errmsg, int *errmsg_len, int want_buf</span>
<a name="l00319"></a>00319         <span class="keywordtype">char</span> errmsg[200] = {0};
<a name="l00320"></a>00320         <span class="keywordtype">int</span> emlen = 0;
<a name="l00321"></a>00321         libssh2_session_last_error(this-&gt;<a class="code" href="class_sync_transfer_thread.html#ab4c02dde0dda8f4fb95a99c9d9782453">ssh2_sess</a>, (<span class="keywordtype">char</span> **)&amp;errmsg, &amp;emlen, 0);
<a name="l00322"></a>00322         <a class="code" href="utils_8h.html#a387853dd138b03f9523b75ee4c7e4a78">q_debug</a>()&lt;&lt;<span class="stringliteral">&quot;sftp set stat error: &quot;</span>&lt;&lt;errmsg;
<a name="l00323"></a>00323     }
<a name="l00324"></a>00324 
<a name="l00325"></a>00325     attr.flags = LIBSSH2_SFTP_ATTR_ACMODTIME;
<a name="l00326"></a>00326     attr.mtime = time.toTime_t();
<a name="l00327"></a>00327 
<a name="l00328"></a>00328     ret = libssh2_sftp_setstat(this-&gt;<a class="code" href="class_sync_transfer_thread.html#a8be0003156ab3c73520c300ea14e51f1">ssh2_sftp</a>, <a class="code" href="class_global_option.html#a23a5b10888b23504a10b5c7b96bddc62">GlobalOption::instance</a>()-&gt;remote_codec-&gt;fromUnicode(fileName), &amp;attr);
<a name="l00329"></a>00329     <span class="keywordflow">if</span> (ret != 0) {
<a name="l00330"></a>00330         <span class="keywordtype">char</span> errmsg[200] = {0};
<a name="l00331"></a>00331         <span class="keywordtype">int</span> emlen = 0;
<a name="l00332"></a>00332         libssh2_session_last_error(this-&gt;<a class="code" href="class_sync_transfer_thread.html#ab4c02dde0dda8f4fb95a99c9d9782453">ssh2_sess</a>, (<span class="keywordtype">char</span> **)&amp;errmsg, &amp;emlen, 0);
<a name="l00333"></a>00333         <a class="code" href="utils_8h.html#a387853dd138b03f9523b75ee4c7e4a78">q_debug</a>()&lt;&lt;<span class="stringliteral">&quot;sftp set stat error: &quot;</span>&lt;&lt;errmsg;
<a name="l00334"></a>00334     }
<a name="l00335"></a>00335     <span class="keywordflow">return</span> 0;
<a name="l00336"></a>00336 }
<a name="l00337"></a>00337 
<a name="l00338"></a><a class="code" href="class_sync_transfer_thread.html#aab1a4d450ca4bfdf64e2b6f5ed869c94">00338</a> <span class="keywordtype">bool</span> <a class="code" href="class_sync_transfer_thread.html#aab1a4d450ca4bfdf64e2b6f5ed869c94">SyncTransferThread::setRemoteSession</a>(QString sess)
<a name="l00339"></a>00339 {
<a name="l00340"></a>00340     this-&gt;<a class="code" href="class_sync_transfer_thread.html#ad65553aaf9720a669c3cb50419fc106b">sess_name</a> = sess;
<a name="l00341"></a>00341     this-&gt;start();
<a name="l00342"></a>00342     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00343"></a>00343 }
<a name="l00344"></a>00344 
<a name="l00345"></a><a class="code" href="class_sync_transfer_thread.html#a959e8425f659968b5eb08448e0617ee3">00345</a> <span class="keywordtype">bool</span> <a class="code" href="class_sync_transfer_thread.html#a959e8425f659968b5eb08448e0617ee3">SyncTransferThread::setBasePath</a>(QString local, QString remote)
<a name="l00346"></a>00346 {
<a name="l00347"></a>00347     this-&gt;<a class="code" href="class_sync_transfer_thread.html#ad9c61029cc82f0e9f39561e3adb6aba6">local_base_path</a> = local;
<a name="l00348"></a>00348     this-&gt;<a class="code" href="class_sync_transfer_thread.html#ae6d48e34639c085cbaf94f8d16e0a783">remote_base_path</a> = remote;
<a name="l00349"></a>00349     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00350"></a>00350 }
<a name="l00351"></a>00351 
<a name="l00352"></a><a class="code" href="class_sync_transfer_thread.html#a9c49b7605093c2f8dd95df63a5046a21">00352</a> <span class="keywordtype">bool</span> <a class="code" href="class_sync_transfer_thread.html#a9c49b7605093c2f8dd95df63a5046a21">SyncTransferThread::addTask</a>(<a class="code" href="class_sync_task_package.html">SyncTaskPackage</a> task)
<a name="l00353"></a>00353 {
<a name="l00354"></a>00354     <span class="keywordflow">if</span> (task.<a class="code" href="class_sync_task_package.html#a75a745502b410a9c7a5ff6a48b6cd2cf">mpAttr</a> != NULL) {
<a name="l00355"></a>00355         this-&gt;<a class="code" href="class_sync_transfer_thread.html#a2aebe583aa8473fad635919bbfaf1383">tMutex</a>.lock();
<a name="l00356"></a>00356         this-&gt;<a class="code" href="class_sync_transfer_thread.html#ab6afbfd258dc28d46ab7aea47a3e143d">taskQueue</a>.enqueue(task);
<a name="l00357"></a>00357         this-&gt;<a class="code" href="class_sync_transfer_thread.html#a2aebe583aa8473fad635919bbfaf1383">tMutex</a>.unlock();
<a name="l00358"></a>00358         this-&gt;<a class="code" href="class_sync_transfer_thread.html#abdbba287c0749c6ae8efa8d5d1516509">wc</a>.wakeOne();
<a name="l00359"></a>00359     } <span class="keywordflow">else</span> {
<a name="l00360"></a>00360         <a class="code" href="utils_8h.html#a387853dd138b03f9523b75ee4c7e4a78">q_debug</a>()&lt;&lt;<span class="stringliteral">&quot;Invalid task:&quot;</span>&lt;&lt;task.<a class="code" href="class_sync_task_package.html#ae2dc5afdc3ffab8599fde6a324d76ad6">msFileName</a>&lt;&lt;task.<a class="code" href="class_sync_task_package.html#a75a745502b410a9c7a5ff6a48b6cd2cf">mpAttr</a>&lt;&lt;task.<a class="code" href="class_sync_task_package.html#aa59963442208b78f07b5a22b1f19a5b4">mnDirect</a>;
<a name="l00361"></a>00361     }
<a name="l00362"></a>00362     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00363"></a>00363 }
<a name="l00364"></a>00364 
<a name="l00365"></a><a class="code" href="class_sync_transfer_thread.html#aba5cd9bd2b376175adc25335f900b6fb">00365</a> <span class="keywordtype">bool</span> <a class="code" href="class_sync_transfer_thread.html#aba5cd9bd2b376175adc25335f900b6fb">SyncTransferThread::connectToRemoteHost</a>()
<a name="l00366"></a>00366 {
<a name="l00367"></a>00367     QMap&lt;QString, QString&gt; host;
<a name="l00368"></a>00368     <a class="code" href="class_base_storage.html">BaseStorage</a> *storage = <a class="code" href="class_base_storage.html#a1f27e298c09b394d68ad136b68dd0782">BaseStorage::instance</a>();
<a name="l00369"></a>00369 
<a name="l00370"></a>00370     this-&gt;<a class="code" href="class_sync_transfer_thread.html#a2e2305b8f379f18cf6edfdd191708301">remoteHost</a> = host = storage-&gt;<a class="code" href="class_base_storage.html#a760d3524380b7ef982962ffbeaecbe0c">getHost</a>(<a class="code" href="class_sync_transfer_thread.html#ad65553aaf9720a669c3cb50419fc106b">sess_name</a>);
<a name="l00371"></a>00371     <a class="code" href="utils_8h.html#a387853dd138b03f9523b75ee4c7e4a78">q_debug</a>()&lt;&lt;host;
<a name="l00372"></a>00372     
<a name="l00373"></a>00373     <span class="comment">// RemoteHostConnectThread *conn </span>
<a name="l00374"></a>00374     <span class="comment">//     = new RemoteHostConnectThread(host[&quot;user_name&quot;], host[&quot;password&quot;], host[&quot;host_name&quot;],</span>
<a name="l00375"></a>00375     <span class="comment">//                                   host[&quot;port&quot;].toShort(), host[&quot;pubkey&quot;]);</span>
<a name="l00376"></a>00376     <span class="comment">// conn-&gt;run();</span>
<a name="l00377"></a>00377     <span class="comment">// ssh2_sess = (LIBSSH2_SESSION*)conn-&gt;get_ssh2_sess();</span>
<a name="l00378"></a>00378     <span class="comment">// delete conn; conn = NULL;</span>
<a name="l00379"></a>00379     <a class="code" href="class_s_s_h_connection.html">SSHConnection</a> *conn = <span class="keyword">new</span> <a class="code" href="class_s_s_h_connection.html">SSHConnection</a>();
<a name="l00380"></a>00380     conn-&gt;<a class="code" href="class_connection.html#a11eabb062ab01ea60ebfa65ca9d1a192">setHostInfo</a>(host);
<a name="l00381"></a>00381     conn-&gt;<a class="code" href="class_s_s_h_connection.html#a737f6d12076a6cc9a7998812c9ab6e00">connect</a>();
<a name="l00382"></a>00382     <a class="code" href="class_sync_transfer_thread.html#ab4c02dde0dda8f4fb95a99c9d9782453">ssh2_sess</a> = conn-&gt;<a class="code" href="class_connection.html#ac3055d7d6c5cc14a86dd8bff3aa00a2e">sess</a>;
<a name="l00383"></a>00383     Q_ASSERT(<a class="code" href="class_sync_transfer_thread.html#ab4c02dde0dda8f4fb95a99c9d9782453">ssh2_sess</a> != NULL);
<a name="l00384"></a>00384 
<a name="l00385"></a>00385     <a class="code" href="class_sync_transfer_thread.html#a8be0003156ab3c73520c300ea14e51f1">ssh2_sftp</a> = libssh2_sftp_init(<a class="code" href="class_sync_transfer_thread.html#ab4c02dde0dda8f4fb95a99c9d9782453">ssh2_sess</a>);
<a name="l00386"></a>00386     
<a name="l00387"></a>00387     <span class="keywordflow">if</span> (<a class="code" href="class_sync_transfer_thread.html#a8be0003156ab3c73520c300ea14e51f1">ssh2_sftp</a> != NULL) {
<a name="l00388"></a>00388         Q_ASSERT(<a class="code" href="class_sync_transfer_thread.html#a8be0003156ab3c73520c300ea14e51f1">ssh2_sftp</a> != NULL);
<a name="l00389"></a>00389         <a class="code" href="utils_8h.html#a387853dd138b03f9523b75ee4c7e4a78">q_debug</a>()&lt;&lt;<span class="stringliteral">&quot;connect ok&quot;</span>;
<a name="l00390"></a>00390         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00391"></a>00391     }
<a name="l00392"></a>00392     
<a name="l00393"></a>00393     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00394"></a>00394 }
<a name="l00395"></a>00395 
<a name="l00396"></a><a class="code" href="class_sync_transfer_thread.html#af92603b26abf166c0eb89d75d1b41b22">00396</a> <span class="keywordtype">void</span> <a class="code" href="class_sync_transfer_thread.html#af92603b26abf166c0eb89d75d1b41b22">SyncTransferThread::slot_syncDownload</a>(QPair&lt;QString, LIBSSH2_SFTP_ATTRIBUTES*&gt; task)
<a name="l00397"></a>00397 {
<a name="l00398"></a>00398     <a class="code" href="utils_8h.html#a387853dd138b03f9523b75ee4c7e4a78">q_debug</a>()&lt;&lt;<span class="stringliteral">&quot;&quot;</span>;
<a name="l00399"></a>00399     <a class="code" href="class_sync_task_package.html">SyncTaskPackage</a> pkg(task.first, task.second, <a class="code" href="class_sync_transfer_thread.html#abd241410e5359aa406455b981579542ea1ef4a1cac27b6de9502d5e4ccedd1430">TASK_DOWNLOAD</a>);
<a name="l00400"></a>00400     this-&gt;<a class="code" href="class_sync_transfer_thread.html#a9c49b7605093c2f8dd95df63a5046a21">addTask</a>(pkg);
<a name="l00401"></a>00401 }
<a name="l00402"></a>00402 
<a name="l00403"></a><a class="code" href="class_sync_transfer_thread.html#a355afe899aeebabfd839e8d59d43a745">00403</a> <span class="keywordtype">void</span> <a class="code" href="class_sync_transfer_thread.html#a355afe899aeebabfd839e8d59d43a745">SyncTransferThread::slot_syncUpload</a>(QPair&lt;QString, LIBSSH2_SFTP_ATTRIBUTES*&gt; task)
<a name="l00404"></a>00404 {
<a name="l00405"></a>00405     <a class="code" href="class_sync_task_package.html">SyncTaskPackage</a> pkg(task.first, task.second, <a class="code" href="class_sync_transfer_thread.html#abd241410e5359aa406455b981579542ea5765bf12d36b45c3e59ae18bc0793a26">TASK_UPLOAD</a>);
<a name="l00406"></a>00406     this-&gt;<a class="code" href="class_sync_transfer_thread.html#a9c49b7605093c2f8dd95df63a5046a21">addTask</a>(pkg);
<a name="l00407"></a>00407 }
<a name="l00408"></a>00408 
</pre></div></div>
<div id="the-footer">

  <p>
    <a href="http://www.qtchina.net">www.qtchina.net</a>
	<a href="http://sourceforge.net/donate/index.php?group_id=186258" target="_blank"><img src="http://images.sourceforge.net/images/project-support.jpg" width="88" height="32" border="0" alt="Support This Project" /> </a> 

    <script src='http://s34.cnzz.com/stat.php?id=626330&web_id=626330' language='JavaScript' charset='utf8'></script>
</center>
<script src="http://www.google-analytics.com/urchin.js" type="text/javascript">
</script>
<script type="text/javascript">
  _uacct = "UA-2849302-1";
  urchinTracker();
</script>
</p>
</div>
