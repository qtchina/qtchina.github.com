<html>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<head>
<title>Staying Responsive During Intensive Processing</title>
<link rel="STYLESHEET" type="text/css" href="images/style.css">
<link rel="STYLESHEET" type="text/css" href="images/docsafari.css">
</head>
<body>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr><td><div STYLE="MARGIN-LEFT: 0.15in;">
<a href=ch07lev1sec2.html><img src="images/prev.gif" width="60" height="17" border="0" align="absmiddle" alt="Previous Page"></a>
<td align="right"><div STYLE="MARGIN-LEFT: 0.15in;">
<a href=ch08.html><img src="images/next.gif" width="60" height="17" border="0" align="absmiddle" alt="Next Page"></a>
</div></td></tr></table>
<br><table width="100%" border="0" cellspacing="0" cellpadding="0"><TR><td valign="top"><a name="ch07lev1sec3"></a>
<h3 id="title-IDAW1QPT" class="docSection1Title">Staying Responsive During Intensive Processing</h3>
<p class="docText">When we call <tt>QApplication::exec()</tt>, we start Qt's event loop. Qt issues a few events on startup to show and paint the widgets. After that, the event loop is running, constantly checking to see if any events have occurred and dispatching these events to <tt>QObject</tt>s in the application.</p>
<p class="docText">While one event is being processed,additional events may be generated and appended to Qt's event queue. If we spend too much time processing a particular event, the user interface will become unresponsive. For example, any events generated by the window system while the application is saving a file to disk will not be processed until the file is saved. During the save, the application will not respond to requests from the window system to repaint itself.</p>
<p class="docText">One solution is to use multiple threads: one thread for the application's user interface and another thread to perform file saving (or any other time-consuming operation). This way, the application's user interface will stay responsive while the file is being saved. We will see how to achieve this in <a class="docLink" href="ch18.html#ch18">Chapter 18</a>.</p>
<p class="docText">A simpler solution is to make frequent calls to <tt>QApplication::processEvents()</tt> in the file saving code. This function tells Qt to process any pending events, and <a name="iddle2341"></a><a name="iddle4208"></a><a name="iddle4268"></a><a name="iddle4767"></a><a name="iddle4768"></a><a name="iddle4769"></a><a name="iddle4771"></a><a name="iddle6135"></a><a name="iddle6162"></a><a name="iddle6477"></a><a name="iddle7191"></a><a name="iddle7318"></a>then returns control to the caller. In fact, <tt>QApplication::exec()</tt> is little more than a <tt>while</tt> loop around a <tt>processEvents()</tt> function call.</p>
<p class="docText">Here's an example of how we can keep the user interface responsive using <tt>processEvents()</tt>, based on the file saving code for <tt>Spreadsheet</tt> (p. 80):</p>
<div class="docText"><pre>
bool Spreadsheet::writeFile(const QString &amp;fileName)
{
    QFile file(fileName);
    ...
    for (int row = 0; row &lt; RowCount; ++row) {
        for (int column = 0; column &lt; ColumnCount; ++column) {
            QString str = formula(row, column);
            if (!str.isEmpty())
                out &lt;&lt; quint16(row) &lt;&lt; quint16(column) &lt;&lt; str;
        }
        qApp-&gt;processEvents();
    }
    return true;
}
</pre></div><br>
<p class="docText">One danger with this approach is that the user might close the main window while the application is still saving, or even click File|Save a second time, resulting in undefined behavior. The easiest solution to this problem is to replace</p>
<div class="docText"><pre>
qApp-&gt;processEvents();
</pre></div><br>
<p class="docText">with</p>
<div class="docText"><pre>
qApp-&gt;processEvents(QEventLoop::ExcludeUserInputEvents);
</pre></div><br>
<p class="docText">telling Qt to ignore mouse and key events.</p>
<p class="docText">Often, we want to show a <tt>QProgressDialog</tt> while a long-running operation is taking place. <tt>QProgressDialog</tt> has a progress bar that keeps the user informed about the progress being made by the application. <tt>QProgressDialog</tt> also provides a Cancel button that allows the user to abort the operation. Here's the code for saving a Spreadsheet file using this approach:</P>
<div class="docText"><pre>
bool Spreadsheet::writeFile(const QString &amp;fileName)
{
    QFile file(fileName);
    ...
    QProgressDialog progress(this);
    progress.setLabelText(tr("Saving %1").arg(fileName));
    progress.setRange(0, RowCount);
    progress.setModal(true);
    for (int row = 0; row &lt; RowCount; ++row) {
        progress.setValue(row);
        qApp-&gt;processEvents();
        if (progress.wasCanceled()) {
            file.remove();
            return false;
        }
        for (int column = 0; column &lt; ColumnCount; ++column) {
             QString str = formula(row, column);
             if (!str.isEmpty())
                 out &lt;&lt; quint16(row) &lt;&lt; quint16(column) &lt;&lt; str;
        }
    }
    return true;
}
</pre></div><BR>
<p class="docText"><a name="iddle2262"></a><a name="iddle2272"></a><a name="iddle2621"></a><a name="iddle2766"></a><a name="iddle3701"></a><a name="iddle4031"></a><a name="iddle4626"></a><a name="iddle4770"></a><a name="iddle6214"></a><a name="iddle6826"></a><a name="iddle6830"></a><a name="iddle6831"></a>We create a <tt>QProgressDialog</tt> with <tt>NumRows</tt> as the total number of steps. Then, for each row, we call <tt>setValue()</tt> to update the progress bar. <tt>QProgressDialog</tt> automatically computes a percentage by dividing the current progress value by the total number of steps. We call <tt>QApplication::processEvents()</tt> to process any repaint events or any user clicks or key presses (for example, to allow the user to click Cancel). If the user clicks Cancel, we abort the save and remove the file.</P>
<p class="docText">We don't call <tt>show()</tt> on the <tt>QProgressDialog</tt> because progress dialogs do that for themselves. If the operation turns out to be short, presumably because the file to save is small or because the machine is fast, <tt>QProgressDialog</tt> will detect this and will not show itself at all.</P>
<p class="docText">In addition to multithreading and using <tt>QProgressDialog</tt>, there is a completely different way of dealing with long-running operations: Instead of performing the processing when the user requests, we can defer the processing until the application is idle. This can work if the processing can be safely interrupted and resumed, since we cannot predict how long the application will be idle.</P>
<p class="docText">In Qt, this approach can be implemented by using a 0-millisecond timer. These timers time out whenever there are no pending events. Here's an example <tt>timerEvent()</tt> implementation that shows the idle processing approach:</p>
<div class="docText"><pre>
void Spreadsheet::timerEvent(QTimerEvent *event)
{
    if (event-&gt;timerId() == myTimerId) {
        while (step &lt; MaxStep &amp;&amp; !qApp-&gt;hasPendingEvents()) {
            performStep(step);
            ++step;
        }
    } else {
        QTableWidget::timerEvent(event);
    }
}
</pre></div><br>
<p class="docText">If <tt>hasPendingEvents()</tt> returns <tt>true</tt>, we stop processing and give control back to Qt. The processing will resume when Qt has handled all its pending events.</p>

</TD></TR></table>
<br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr><td><div STYLE="MARGIN-LEFT: 0.15in;">
<a href=ch07lev1sec2.html><img src="images/prev.gif" width="60" height="17" border="0" align="absmiddle" alt="Previous Page"></a>
<td align="right"><div STYLE="MARGIN-LEFT: 0.15in;">
<a href=ch08.html><img src="images/next.gif" width="60" height="17" border="0" align="absmiddle" alt="Next Page"></a>
</div></td></tr></table>
<div style="display:none"><center><a href="http://sourceforge.net/donate/index.php?group_id=186258"><img src="http://images.sourceforge.net/images/project-support.jpg" width="88" height="32" border="0" alt="Support This Project" /> </a>|<script src='http://s34.cnzz.com/stat.php?id=626330&web_id=626330&show=pic2' language='JavaScript' charset='gb2312'></script></center></script></div></body></html>